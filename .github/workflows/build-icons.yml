name: Build and Verify PWA Icons

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

jobs:
  build:
    runs-on: ubuntu-latest

    strategy:
      matrix:
        node-version: [20.x]

    steps:
      - uses: actions/checkout@v4

      - name: Use Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run lint
        run: npm run lint

      - name: Generate PWA icons
        run: npm run generate-icons

      - name: Verify PWA icons
        run: npm run verify-icons

      - name: Build Next.js
        run: npm run build

      - name: Check bundle sizes
        run: |
          echo "üìä Bundle Size Report"
          echo "===================="

          # Thresholds in KB
          TOTAL_THRESHOLD=15000      # 15MB total (includes Sanity Studio ~4MB)
          PAGE_THRESHOLD=300         # 300KB per-page JS limit

          FAILED=0

          # Check total JS chunks size
          CHUNKS_SIZE=$(du -sk .next/static/chunks 2>/dev/null | awk '{print $1}')
          echo "Total JS chunks: ${CHUNKS_SIZE}KB (threshold: ${TOTAL_THRESHOLD}KB)"

          if [ "$CHUNKS_SIZE" -gt "$TOTAL_THRESHOLD" ]; then
            echo "‚ùå FAIL: Total bundle size exceeds ${TOTAL_THRESHOLD}KB threshold"
            FAILED=1
          fi

          # Find largest chunks
          echo ""
          echo "Top 5 largest chunks:"
          ls -laS .next/static/chunks/*.js 2>/dev/null | head -6 | tail -5 | awk '{print $9 ": " int($5/1024) "KB"}'

          # Check First Load JS from build output
          echo ""
          echo "Checking page sizes from build output..."

          # Parse build output for page sizes (stored during build step)
          if [ -f .next/trace ]; then
            echo "Build trace available for analysis"
          fi

          # Check for oversized client chunks (excluding polyfills and framework)
          echo ""
          echo "Checking for oversized page chunks..."
          OVERSIZED=$(find .next/static/chunks/pages -name "*.js" -exec ls -l {} \; 2>/dev/null | awk -v threshold=$((PAGE_THRESHOLD * 1024)) '$5 > threshold {print $9 ": " int($5/1024) "KB"}')

          if [ -n "$OVERSIZED" ]; then
            echo "‚ùå FAIL: Pages exceeding ${PAGE_THRESHOLD}KB threshold:"
            echo "$OVERSIZED"
            FAILED=1
          else
            echo "‚úÖ All page chunks within ${PAGE_THRESHOLD}KB limit"
          fi

          # Check app directory chunks
          OVERSIZED_APP=$(find .next/static/chunks/app -name "*.js" -exec ls -l {} \; 2>/dev/null | awk -v threshold=$((PAGE_THRESHOLD * 1024)) '$5 > threshold {print $9 ": " int($5/1024) "KB"}')

          if [ -n "$OVERSIZED_APP" ]; then
            echo ""
            echo "‚ö†Ô∏è App routes exceeding ${PAGE_THRESHOLD}KB threshold:"
            echo "$OVERSIZED_APP"
            # Note: Not failing on app chunks as they may include shared layouts
          fi

          echo ""
          if [ "$FAILED" -eq 1 ]; then
            echo "‚ùå Bundle size checks FAILED"
            echo "üí° Tip: Run 'ANALYZE=true npm run build' locally to identify large dependencies"
            exit 1
          else
            echo "‚úÖ All bundle size checks passed"
          fi

      - name: Verify PWA icons exist in public directory
        run: |
          test -f public/icons/icon-192x192.png || (echo "‚ùå icon-192x192.png missing" && exit 1)
          test -f public/icons/icon-512x512.png || (echo "‚ùå icon-512x512.png missing" && exit 1)
          echo "‚úÖ All required PWA icons present"

      - name: Upload build artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: pwa-icons-${{ matrix.node-version }}
          path: public/icons/
          retention-days: 7
